!function(){"use strict";class t{constructor(t){this.url=t,this.contentTypeHeader={"Content-Type":"application/json"}}load(){return fetch(this.url)}send(t){return fetch(this.url,{body:JSON.stringify(t),method:"POST",headers:this.contentTypeHeader})}put(t){return fetch(this.url,{body:t,method:"PUT"})}}new class{constructor(t){this.el=t,this.sendForm=this.el.querySelector(".send"),this.searchForm=this.el.querySelector(".search"),this.attachForm=this.el.querySelector(".file"),this.geoButton=this.sendForm.querySelector(".geoButton"),this.textInput=this.sendForm.querySelector(".textInput"),this.searchInput=this.searchForm.querySelector(".searchInput"),this.field=this.el.querySelector(".messages"),this.favorite=this.el.querySelector(".favoritesField"),this.search=this.el.querySelector(".searchResult"),this.ws=new WebSocket("wss://ahj44-server-evgeniy-loznevoy.herokuapp.com/")}init(){this.sendForm.addEventListener("submit",this.sendMessage.bind(this)),this.searchForm.addEventListener("submit",this.searchMessage.bind(this)),this.attachForm.addEventListener("change",this.sendAttach.bind(this)),this.geoButton.addEventListener("click",this.sendGeo.bind(this)),this.ws.addEventListener("open",(()=>{this.ws.send("hello")})),this.ws.addEventListener("message",(t=>{const e=t.data,s=JSON.parse(e);console.log(s),this.drawMessages(s)})),this.ws.addEventListener("close",(async t=>{console.log("connection closed",t)})),this.ws.addEventListener("error",(()=>{console.log("error")}))}drawMessages(t){this.field.innerHTML="",this.favorite.innerHTML="";for(const e of t){const t=document.createElement("div");if(t.classList.add("message"),t.dataset.id=e.id,"text"===e.type||"geo"===e.type?(t.innerHTML=`\n          <p class="text">${e.message}</p>\n          <button class="${e.favorite?"favoriteButtonOn":"favoriteButtonOff"} favButton"><3</button>\n        `,this.field.appendChild(t)):"link"===e.type?(t.innerHTML=`\n          <a class="anchor" href='${e.message}'>${e.message}</a>\n          <button class="${e.favorite?"favoriteButtonOn":"favoriteButtonOff"} favButton"><3</button>\n        `,this.field.appendChild(t)):"file"===e.type&&(t.innerHTML=`\n          <img class="image" src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSYN2iKuaJSIZZwk0Oc2CJkZiGpsCdEgF933g&usqp=CAU' alt='${e.message}'>\n          <button class="downloadButton" type="file">Download</button>\n          <button class="${e.favorite?"favoriteButtonOn":"favoriteButtonOff"} favButton"><3</button>\n        `,t.querySelector(".downloadButton").addEventListener("click",this.download.bind(this)),this.field.appendChild(t)),e.favorite){const t=document.createElement("div");t.classList.add("favorite"),t.textContent=e.message.slice(0,18),this.favorite.appendChild(t)}t.querySelector(".favButton").addEventListener("click",this.favoriteSwitch.bind(this)),this.field.scrollTop=this.field.scrollHeight}}async favoriteSwitch(e){e.preventDefault();const{id:s}=e.target.closest(".message").dataset;let a={};a=e.target.classList.contains("favoriteButtonOff")?{id:s,isFavorite:!0}:{id:s,isFavorite:!1};const n=new t("https://diploma-kxrxll.herokuapp.com/favorite"),i=await n.send(a);200===i.status&&i.ok&&(this.textInput.value="",this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async sendMessage(e){e.preventDefault();let s={};s=this.textInput.value.startsWith("www")||this.textInput.value.startsWith("http")?{id:Math.floor(1e4*Math.random()),type:"link",message:this.textInput.value,favorite:!1}:{id:Math.floor(1e4*Math.random()),type:"text",favorite:!1,message:this.textInput.value};const a=new t("https://diploma-kxrxll.herokuapp.com/newmessage"),n=await a.send(s);200===n.status&&n.ok&&(this.textInput.value="",this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async sendAttach(e){e.preventDefault();const s=this.attachForm.querySelector("input").files[0],a=new FormData;a.append("file",s);const n=new t("https://diploma-kxrxll.herokuapp.com/download"),i=await n.put(a);200===i.status&&i.ok&&(await console.log(i),this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async sendGeo(e){e.preventDefault();const s=await new Promise(((t,e)=>{navigator.geolocation.getCurrentPosition(t,e)})),{latitude:a,longitude:n}=s.coords,i=`[${a}, ${n}]`,o={id:Math.floor(1e4*Math.random()),type:"geo",message:i,favorite:!1},r=new t("https://diploma-kxrxll.herokuapp.com/newmessage"),h=await r.send(o);200===h.status&&h.ok&&(this.textInput.value="",this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async searchMessage(e){e.preventDefault(),this.search.innerHTML="";const s={str:this.searchInput.value},a=new t("https://diploma-kxrxll.herokuapp.com/search"),n=await a.send(s);if(200===n.status&&n.ok){const t=await n.json();for(const e of t){const t=document.createElement("div");t.classList.add("result"),t.textContent=e.message.slice(0,10),this.search.appendChild(t)}}}async download(t){t.preventDefault();const{id:e}=t.target.closest(".message").dataset}}(document.querySelector(".Testogram")).init()}();