!function(){"use strict";class e{constructor(e){this.url=e,this.contentTypeHeader={"Content-Type":"application/json"}}load(){return fetch(this.url)}send(e){return fetch(this.url,{body:JSON.stringify(e),method:"POST",headers:this.contentTypeHeader})}put(e){return fetch(this.url,{body:e,method:"PUT"})}}new class{constructor(e){this.el=e,this.sendForm=this.el.querySelector(".send"),this.searchForm=this.el.querySelector(".search"),this.attachForm=this.el.querySelector(".file"),this.geoButton=this.sendForm.querySelector(".geoButton"),this.textInput=this.sendForm.querySelector(".textInput"),this.searchInput=this.searchForm.querySelector(".searchInput"),this.field=this.el.querySelector(".messages"),this.favorite=this.el.querySelector(".favoritesField"),this.search=this.el.querySelector(".searchResult"),this.ws=new WebSocket("wss://ahj44-server-evgeniy-loznevoy.herokuapp.com/")}init(){this.sendForm.addEventListener("submit",this.sendMessage.bind(this)),this.searchForm.addEventListener("submit",this.searchMessage.bind(this)),this.attachForm.addEventListener("change",this.sendAttach.bind(this)),this.geoButton.addEventListener("click",this.sendGeo.bind(this)),this.ws.addEventListener("open",(()=>{this.ws.send("hello")})),this.ws.addEventListener("message",(e=>{const t=e.data,s=JSON.parse(t);console.log(s),this.drawMessages(s)})),this.ws.addEventListener("close",(async e=>{console.log("connection closed",e)})),this.ws.addEventListener("error",(()=>{console.log("error")}))}drawMessages(e){this.field.innerHTML="",this.favorite.innerHTML="";for(const t of e){const e=document.createElement("div");if(e.classList.add("message"),e.dataset.id=t.id,"text"===t.type||"geo"===t.type?(e.innerHTML=`\n          <p class="text">${t.message}</p>\n          <button class="${t.favorite?"favoriteButtonOn":"favoriteButtonOff"} favButton"><3</button>\n        `,this.field.appendChild(e)):"link"===t.type?(e.innerHTML=`\n          <a class="anchor" href='${t.message}'>${t.message}</a>\n          <button class="${t.favorite?"favoriteButtonOn":"favoriteButtonOff"} favButton"><3</button>\n        `,this.field.appendChild(e)):"file"===t.type&&(e.innerHTML=`\n          <img class="image" src='https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSYN2iKuaJSIZZwk0Oc2CJkZiGpsCdEgF933g&usqp=CAU' alt='${t.message}'>\n          <button class="downloadButton" type="file">Download</button>\n          <button class="${t.favorite?"favoriteButtonOn":"favoriteButtonOff"} favButton"><3</button>\n        `,e.querySelector(".downloadButton").addEventListener("click",this.download.bind(this)),this.field.appendChild(e)),t.favorite){const e=document.createElement("div");e.classList.add("favorite"),e.textContent=t.message.slice(0,18),this.favorite.appendChild(e)}e.querySelector(".favButton").addEventListener("click",this.favoriteSwitch.bind(this)),this.field.scrollTop=this.field.scrollHeight}}async favoriteSwitch(t){t.preventDefault();const{id:s}=t.target.closest(".message").dataset;let a={};a=t.target.classList.contains("favoriteButtonOff")?{id:s,isFavorite:!0}:{id:s,isFavorite:!1};const n=new e("https://ahj44-server-evgeniy-loznevoy.herokuapp.com/favorite"),o=await n.send(a);200===o.status&&o.ok&&(this.textInput.value="",this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async sendMessage(t){t.preventDefault();let s={};s=this.textInput.value.startsWith("www")||this.textInput.value.startsWith("http")?{id:Math.floor(1e4*Math.random()),type:"link",message:this.textInput.value,favorite:!1}:{id:Math.floor(1e4*Math.random()),type:"text",favorite:!1,message:this.textInput.value};const a=new e("https://ahj44-server-evgeniy-loznevoy.herokuapp.com/newmessage"),n=await a.send(s);200===n.status&&n.ok&&(this.textInput.value="",this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async sendAttach(t){t.preventDefault();const s=this.attachForm.querySelector("input").files[0],a=new FormData;a.append("file",s);const n=new e("https://ahj44-server-evgeniy-loznevoy.herokuapp.com/download"),o=await n.put(a);200===o.status&&o.ok&&(await console.log(o),this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async sendGeo(t){t.preventDefault();const s=await new Promise(((e,t)=>{navigator.geolocation.getCurrentPosition(e,t)})),{latitude:a,longitude:n}=s.coords,o=`[${a}, ${n}]`,i={id:Math.floor(1e4*Math.random()),type:"geo",message:o,favorite:!1},r=new e("https://ahj44-server-evgeniy-loznevoy.herokuapp.com/newmessage"),h=await r.send(i);200===h.status&&h.ok&&(this.textInput.value="",this.ws.readyState===WebSocket.OPEN&&this.ws.send("New message!"))}async searchMessage(t){t.preventDefault(),this.search.innerHTML="";const s={str:this.searchInput.value},a=new e("https://ahj44-server-evgeniy-loznevoy.herokuapp.com/search"),n=await a.send(s);if(200===n.status&&n.ok){const e=await n.json();for(const t of e){const e=document.createElement("div");e.classList.add("result"),e.textContent=t.message.slice(0,10),this.search.appendChild(e)}}}async download(e){e.preventDefault();const{id:t}=e.target.closest(".message").dataset}}(document.querySelector(".Testogram")).init()}();